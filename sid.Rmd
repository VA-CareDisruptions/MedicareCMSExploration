---
title: "sid"
author: "Dan Weinberger"
date: '2023-07-21'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

---
title: "1. exploratory analyses"
author: "Dan Weinberger"
date: '2023-01-05'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(arrow)
library(tidyr)
library(dplyr)
library(ggplot2)
library(usmap)
library(scales)
#library(spatstat)

vircol <-  viridis_pal()(100)

library(duckdb)
library(plotly)
library(lubridate)
source('./R/plot.fun.R')
source('./R/schema.R')
state_cw <- read.csv('./Data/SSA_state_crosswalk.csv')
#state_cw <- statepop %>% select(fips, abbr)
state.info <- cbind.data.frame(state.name, state.abb, state.region)

```

## TODO
Try to analyze trends by facility; try to pull out Med/Surg separately

## Read in the parquet database

```{r} 
pq_stream_sid <- open_dataset("R:/ParquetData/AZ", format = "parquet")#%>% 
  #dplyr::select(starts_with('I10_DX'), KEY,AMONTH, YEAR,ZIP, AGE,ATYPE,LOS,ZIPINC_QRTL,MRN_R) 

pq_stream_sid_ch <- open_dataset("R:/ParquetData/AZ_chgs", format = "parquet") %>%
   mutate(icu = if_else(is.na(`Detailed charges 10 (as received from source)`),0,1),
         obs_rm = if_else(is.na(`Detailed charges 51 (as received from source)`),0,1)
         ) %>%
    rename(KEY= `HCUP record identifier`) %>%
  dplyr::select(icu, obs_rm, KEY) %>%
  left_join(pq_stream_sid, by='KEY')


#4,5,20,63
# test1 <- pq_stream_sid_ch %>%
#   slice_head( n = 100) %>%
#   collect() #use collect() to take parquet to dataframe


```


How many hospitalizations in 65+ by year?
SID/AHRQ:
2019: 284,107
2020:262,364
2021: 275,424


Compare to Medicare:
2019: 177,798
2020: 155,167
2021: 148,802

ATYPE
0 =  Unknown value (but present in data)
1 =  Emergency (2019: 105,874in Medicare vs 131,766 in SID) 24% diff
2 =  Urgent (2019: 29,569 in Medicare vs 34,247 in SID) 16% diff
3 =  Elective (2019: 39,394  in Medicare vs 50,391 in SID) 27% diff
4 =  Newborn
5 =  Trauma Center
9=Missing ((2019: 161 in Medicare))

```{r, fig.width=6, fig.height=4}
N_hosp_AZ <- pq_stream_sid %>%
      mutate(AGE = if_else(AGE %in% c('','C'),NA_character_,AGE),
      AGE=as.numeric(AGE), 
         YEAR=as.numeric(YEAR)) %>%
  filter(AGE>=65) %>%
  group_by(YEAR, ATYPE) %>%
  summarize(N=n_distinct(MRN_R)) %>% #count number of unique people 
    collect()
```

```{r, fig.width=6, fig.height=3}
ds.fig <- N_hosp_AZ %>%
  arrange(ATYPE, YEAR) %>%
  filter(ATYPE %in% c(1,2,3,4,5)) %>%
  mutate(admit_type =factor(ATYPE, c(1,2,3,4,5), c('Emergency','Urgent', 'Elective','Newborn','Trauma Center')))

ggplot(ds.fig, aes(x=YEAR, y=N)) +
  geom_line() +
  theme_classic() +
  facet_wrap(~admit_type,scales='free')
```

By county
```{r, fig.width=6, fig.height=4}
N_hosp_cnty <- pq_stream_sid %>%
      mutate(AGE = if_else(AGE %in% c('','C'),NA_character_,AGE),
      AGE=as.numeric(AGE), 
         YEAR=as.numeric(YEAR)) %>%
  filter(AGE>=65) %>%
  group_by(YEAR, ZIPINC_QRTL) %>%
  summarize(N=n_distinct(MRN_R)) %>% #count number of unique people 
    collect()
```

```{r}
ggplot(N_hosp_cnty, aes(x=YEAR, y=N)) +
  geom_line() +
  theme_classic() +
  facet_wrap(~ZIPINC_QRTL,scales='free')
```


```{r, fig.width=4, fig.height=2.5}
N_hosp_AZ_tot <- pq_stream_sid %>%
      mutate(AGE = if_else(AGE %in% c('','C'),NA_character_,AGE),
      AGE=as.numeric(AGE), 
         YEAR=as.numeric(YEAR)) %>%
  filter(AGE>=65) %>%
    group_by(YEAR) %>%
  summarize(N=n_distinct(MRN_R)) %>% #count number of unique people 
    collect() %>%
  ungroup()

ggplot(N_hosp_AZ_tot, aes(x=YEAR, y=N)) +
  geom_line() +
  theme_classic() 
```
los dist
```{r}
los1 <- pq_stream_sid %>%
      mutate(AGE = if_else(AGE %in% c('','C'),NA_character_,AGE),
      AGE=as.numeric(AGE), 
         YEAR=as.numeric(YEAR)) %>%
  filter(AGE>=65) %>%
  dplyr::select(YEAR, LOS) %>%
    collect() %>%
  ungroup()

los1 %>% 
  mutate(LOS=as.numeric(LOS)) %>%
ggplot( aes( x=LOS)) +
  geom_histogram() +
  xlim(0,30)+
  theme_classic() +
  facet_wrap(~YEAR)
```

LOS
```{r}
los <- pq_stream_sid %>%
      mutate(AGE = if_else(AGE %in% c('','C'),NA_character_,AGE),
      AGE=as.numeric(AGE), 
      LOS = if_else(LOS %in% c('','C'),NA_character_,LOS),
      LOS=as.numeric(LOS),
         YEAR=as.numeric(YEAR)) %>%
  filter(AGE>=65) %>%
    group_by(YEAR) %>%
  summarize(LOS_mean=mean(LOS, na.rm=T), LOS_median=median(LOS, na.rm=T)) %>% #
    collect() %>%
  ungroup()


ggplot(los, aes(x=YEAR, y=LOS_median)) +
  geom_line() +
  theme_classic() 

ggplot(los, aes(x=YEAR, y=LOS_mean)) +
  geom_line() +
  theme_classic() 
```


```{r}
ptm <- proc.time()
inp1 <- pq_stream_sid_ch %>%
  mutate(   
             all_dx = paste(I10_DX1,I10_DX2,I10_DX3,
                            I10_DX4,
                            I10_DX5,
                            I10_DX6,
                            I10_DX7,
                            I10_DX8,
                            I10_DX9,
                            I10_DX10,
                            I10_DX11,
                            I10_DX12,
                            I10_DX13,
                            I10_DX14,
                            I10_DX15,
                            I10_DX16,
                            I10_DX17,
                            I10_DX18,
                            I10_DX19,
                            I10_DX20,
                            I10_DX21,
                            I10_DX22,
                            I10_DX23,
                            I10_DX24,
                            I10_DX25)
                  )%>%
  filter( grepl('J13',all_dx)|grepl('A403',all_dx)|grepl('G001',all_dx)) %>%
  rename(agey =AGE, death=DIED) %>%
  dplyr::select(all_dx, agey, death, AMONTH, YEAR,ZIP) %>%
  collect()
proc.time() - ptm
```

```{r}
test1 <- inp1 %>%
  mutate(agey=as.numeric(agey),
         agec= if_else(agey<5, 1,
                  if_else(agey>=5 & agey<18,2,
                 if_else(agey>=18 & agey<40,3,
                  if_else(agey>40 & agey<65,4,
                  if_else(agey>=65 & agey<110,5, NA_real_
                  )))))
  )%>%
  group_by(agec) %>%
  summarize(N=n())

View(test1)
```

```{r}



j13_trends <- inp1 %>%
  mutate(date=as.Date(paste(YEAR, AMONTH,'01', sep='-')),
                      AZres=  substr(ZIP,1,2) %in% c('85','86'),
         
         j13 = if_else(grepl('J13',all_dx),"J13","Other IPD")
         ) %>%
  filter(agey>=65 & AZres==1) %>%
  group_by(j13,YEAR) %>%
  summarize(N=n())

```

```{r}
j13_trends %>%
  filter(YEAR>=2017 & j13=='J13') %>%
ggplot(aes(x=YEAR, y=N))+
  geom_line() +
  theme_classic()+
 # facet_wrap(~j13,scales='free' )+
  ylim(0,500)
```


overall prob(death) among COPD hospitalizaions
```{r}

overall_p_death <- inp1 %>%
  group_by(agey) %>%
  mutate(death=as.numeric(death), agey=as.numeric(agey)) %>%
  summarize(cfr=mean(death, na.rm=T)) %>%
  ungroup() %>%
  filter(agey<95)


ggplot(overall_p_death , aes(x=agey, y=cfr)) +
  geom_line() +
  theme_classic()
```

Look at charges among pneumonia patients
```{r}
ptm <- proc.time()
test1 <- pq_stream_sid_ch %>%
  #filter(YEAR==2019 & AMONTH==1 ) %>%
  mutate(   
             all_dx = paste(I10_DX1,I10_DX2,I10_DX3,
                            I10_DX4,
                            I10_DX5,
                            I10_DX6,
                            I10_DX7,
                            I10_DX8,
                            I10_DX9,
                            I10_DX10,
                            I10_DX11,
                            I10_DX12,
                            I10_DX13,
                            I10_DX14,
                            I10_DX15,
                            I10_DX16,
                            I10_DX17,
                            I10_DX18,
                            I10_DX19,
                            I10_DX20,
                            I10_DX21,
                            I10_DX22,
                            I10_DX23,
                            I10_DX24,
                            I10_DX25)
                  )%>%
    filter( grepl('J12',all_dx)|grepl('J13',all_dx)|grepl('J14',all_dx)|grepl('J15',all_dx)|grepl('J16',all_dx)|grepl('J17',all_dx)|grepl('J18',all_dx)) %>%
  group_by(YEAR, AMONTH,AGE, icu, obs_rm) %>%
  collect()
proc.time() - ptm


test.agg <- test1 %>%
  filter(grepl('J13',all_dx)) %>%
  mutate(AGE=as.numeric(AGE),
         agegrp= if_else(AGE<40,1,
                         if_else(AGE>=40 & AGE<65,2,
                            if_else(AGE>=65,3,999)))
         )%>%
  ungroup() %>%
    group_by(YEAR , AMONTH,agegrp) %>%
  summarize( N_cases=n(),
             icu=sum(icu),
             obs_rm=sum(obs_rm))

test.agg2 <- test.agg %>%
  mutate( date= as.Date(paste(YEAR,AMONTH,'01', sep='-'))
) %>%
  filter(agegrp %in% c(1,2,3))

test1 %>%
  filter(grepl('J13',all_dx)) %>%
  mutate(AGE=as.numeric(AGE),
         agegrp= if_else(AGE<40,1,
                         if_else(AGE>=40 & AGE<65,2,
                            if_else(AGE>=65,3,999)))
         )%>%
  ungroup() %>%
    group_by(agegrp,YEAR )  %>%
  mutate(LOS=as.numeric(LOS)) %>%
  summarize(los=mean(LOS , na.rm=T))

ggplot(test.agg2, aes(x=date, y=icu)) +
  geom_line()+
  theme_classic() +
  facet_wrap(~agegrp)

ggplot(test.agg2, aes(x=date, y=N_cases)) +
  geom_line()+
  theme_classic() +
  facet_wrap(~agegrp)

ggplot(test.agg2, aes(x=date, y=obs_rm)) +
  geom_line()+
  theme_classic() +
  facet_wrap(~agegrp)
```



